'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var _rollupPluginBabelHelpers = require('./_virtual/_rollupPluginBabelHelpers.js');
var dom = require('@conform-to/dom');
var z = require('zod');

function _interopNamespace(e) {
	if (e && e.__esModule) return e;
	var n = Object.create(null);
	if (e) {
		Object.keys(e).forEach(function (k) {
			if (k !== 'default') {
				var d = Object.getOwnPropertyDescriptor(e, k);
				Object.defineProperty(n, k, d.get ? d : {
					enumerable: true,
					get: function () { return e[k]; }
				});
			}
		});
	}
	n["default"] = e;
	return Object.freeze(n);
}

var z__namespace = /*#__PURE__*/_interopNamespace(z);

function getFieldsetConstraint(source) {
  function getSchemaShape(schema) {
    if (schema instanceof z__namespace.ZodObject) {
      return schema.shape;
    } else if (schema instanceof z__namespace.ZodEffects) {
      return getSchemaShape(schema.innerType());
    } else if (schema instanceof z__namespace.ZodOptional) {
      return getSchemaShape(schema.unwrap());
    } else if (schema instanceof z__namespace.ZodIntersection) {
      return _rollupPluginBabelHelpers.objectSpread2(_rollupPluginBabelHelpers.objectSpread2({}, getSchemaShape(schema._def.left)), getSchemaShape(schema._def.right));
    }
    return null;
  }
  function inferConstraint(schema) {
    var constraint = {};
    if (schema instanceof z__namespace.ZodEffects) {
      constraint = _rollupPluginBabelHelpers.objectSpread2({}, inferConstraint(schema.innerType()));
    } else if (schema instanceof z__namespace.ZodOptional) {
      constraint = _rollupPluginBabelHelpers.objectSpread2(_rollupPluginBabelHelpers.objectSpread2({}, inferConstraint(schema.unwrap())), {}, {
        required: false
      });
    } else if (schema instanceof z__namespace.ZodDefault) {
      constraint = _rollupPluginBabelHelpers.objectSpread2(_rollupPluginBabelHelpers.objectSpread2({}, inferConstraint(schema.removeDefault())), {}, {
        required: false
      });
    } else if (schema instanceof z__namespace.ZodArray) {
      constraint = _rollupPluginBabelHelpers.objectSpread2(_rollupPluginBabelHelpers.objectSpread2({}, inferConstraint(schema.element)), {}, {
        multiple: true
      });
    } else if (schema instanceof z__namespace.ZodString) {
      for (var check of schema._def.checks) {
        switch (check.kind) {
          case 'min':
            if (!constraint.minLength || constraint.minLength < check.value) {
              constraint.minLength = check.value;
            }
            break;
          case 'max':
            if (!constraint.maxLength || constraint.maxLength > check.value) {
              constraint.maxLength = check.value;
            }
            break;
          case 'regex':
            if (!constraint.pattern) {
              constraint.pattern = check.regex.source;
            }
            break;
        }
      }
    } else if (schema instanceof z__namespace.ZodNumber) {
      for (var _check of schema._def.checks) {
        switch (_check.kind) {
          case 'min':
            if (!constraint.min || constraint.min < _check.value) {
              constraint.min = _check.value;
            }
            break;
          case 'max':
            if (!constraint.max || constraint.max > _check.value) {
              constraint.max = _check.value;
            }
            break;
        }
      }
    } else if (schema instanceof z__namespace.ZodEnum) {
      constraint.pattern = schema.options.map(option =>
      // To escape unsafe characters on regex
      option.replace(/[|\\{}()[\]^$+*?.]/g, '\\$&').replace(/-/g, '\\x2d')).join('|');
    }
    if (typeof constraint.required === 'undefined') {
      constraint.required = true;
    }
    return constraint;
  }
  var shape = getSchemaShape(source);
  var result = {};
  if (shape) {
    for (var [key, def] of Object.entries(shape)) {
      // @ts-expect-error
      result[key] = inferConstraint(def);
    }
  }
  return result;
}
function parse(payload, config) {
  return dom.parse(payload, {
    resolve(payload, intent) {
      var schema = typeof config.schema === 'function' ? config.schema(intent) : config.schema;
      var resolveResult = result => {
        if (result.success) {
          return {
            value: result.data
          };
        }
        return {
          error: result.error.errors.reduce((result, e) => {
            var _config$acceptMultipl;
            var name = dom.getName(e.path);
            if (typeof result[name] === 'undefined') {
              result[name] = e.message;
            } else if ((_config$acceptMultipl = config.acceptMultipleErrors) !== null && _config$acceptMultipl !== void 0 && _config$acceptMultipl.call(config, {
              name,
              intent,
              payload
            })) {
              result[name] = [].concat(result[name], e.message);
            }
            return result;
          }, {})
        };
      };
      return config.async ? schema.safeParseAsync(payload).then(resolveResult) : resolveResult(schema.safeParse(payload));
    }
  });
}
function ifNonEmptyString(fn) {
  return value => {
    if (typeof value !== 'string') {
      return value;
    }
    if (value === '') {
      return undefined;
    }
    return fn(value);
  };
}

exports.getFieldsetConstraint = getFieldsetConstraint;
exports.ifNonEmptyString = ifNonEmptyString;
exports.parse = parse;
